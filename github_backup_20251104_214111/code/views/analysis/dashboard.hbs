<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∏ÇÂ†¥ÂÑÄË°®Êùø - ÊäÄË°ìÂàÜÊûêÁ≥ªÁµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 20px;
        }
        .small-chart {
            position: relative;
            height: 200px;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease-in-out;
        }
        .market-heat {
            background: linear-gradient(135deg, #ef4444, #f97316, #eab308, #22c55e);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Â∞éËà™Ê¨Ñ -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">üìä Â∏ÇÂ†¥ÂÑÄË°®Êùø</h1>
                <p class="text-blue-200">Âç≥ÊôÇÂ∏ÇÂ†¥Êï∏ÊìöËàáÊäÄË°ìÂàÜÊûêÊ¶ÇÊ≥Å</p>
            </div>
            <div class="flex space-x-4">
                <a href="/analysis" class="hover:bg-blue-700 px-3 py-2 rounded">Á∏ΩË¶Ω</a>
                <a href="/analysis/signals" class="hover:bg-blue-700 px-3 py-2 rounded">‰ø°Ëôü</a>
                <a href="/analysis/rankings" class="hover:bg-blue-700 px-3 py-2 rounded">ÊéíË°åÊ¶ú</a>
                <button onclick="autoRefresh()" id="refreshBtn" class="bg-blue-700 hover:bg-blue-800 px-3 py-2 rounded">
                    üîÑ Ëá™ÂãïÂà∑Êñ∞: ÈóúÈñâ
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-6 p-4">
        <!-- Â∏ÇÂ†¥Á∏ΩË¶ΩÊåáÊ®ô -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="metric-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">‰∏äÂ∏ÇËÇ°Á•®</p>
                        <p class="text-2xl font-bold text-blue-600">{{marketStats.twseCount}}</p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-full">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-sm {{#if (gt marketStats.twseChangePercent 0)}}text-green-600{{else}}text-red-600{{/if}}">
                        {{#if (gt marketStats.twseChangePercent 0)}}+{{/if}}{{marketStats.twseChangePercent}}%
                    </span>
                </div>
            </div>

            <div class="metric-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">‰∏äÊ´ÉËÇ°Á•®</p>
                        <p class="text-2xl font-bold text-purple-600">{{marketStats.tpexCount}}</p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-full">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-sm {{#if (gt marketStats.tpexChangePercent 0)}}text-green-600{{else}}text-red-600{{/if}}">
                        {{#if (gt marketStats.tpexChangePercent 0)}}+{{/if}}{{marketStats.tpexChangePercent}}%
                    </span>
                </div>
            </div>

            <div class="metric-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Á∏ΩÊàê‰∫§ÈáëÈ°ç</p>
                        <p class="text-xl font-bold text-green-600">{{formatBillion marketStats.totalTradeValue}}</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-full">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-sm text-gray-600">ÂÑÑÂÖÉ</span>
                </div>
            </div>

            <div class="metric-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">‰∏äÊº≤ËÇ°Á•®</p>
                        <p class="text-2xl font-bold text-green-600">{{marketStats.risingCount}}</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-full">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-sm text-green-600">{{marketStats.risingPercent}}%</span>
                </div>
            </div>

            <div class="metric-card bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">‰∏ãË∑åËÇ°Á•®</p>
                        <p class="text-2xl font-bold text-red-600">{{marketStats.fallingCount}}</p>
                    </div>
                    <div class="p-3 bg-red-100 rounded-full">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-sm text-red-600">{{marketStats.fallingPercent}}%</span>
                </div>
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂúñË°®ÂçÄÂüü -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Â∏ÇÂ†¥ÊåáÊï∏Âúñ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">üìà Â∏ÇÂ†¥ÊåáÊï∏Ëµ∞Âã¢</h3>
                    <div class="flex space-x-2">
                        <button onclick="changeTimeframe('1D')" class="timeframe-btn px-3 py-1 text-sm border rounded active">1Êó•</button>
                        <button onclick="changeTimeframe('5D')" class="timeframe-btn px-3 py-1 text-sm border rounded">5Êó•</button>
                        <button onclick="changeTimeframe('1M')" class="timeframe-btn px-3 py-1 text-sm border rounded">1Êúà</button>
                        <button onclick="changeTimeframe('3M')" class="timeframe-btn px-3 py-1 text-sm border rounded">3Êúà</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="marketIndexChart"></canvas>
                </div>
            </div>

            <!-- Â∏ÇÂ†¥ÁÜ±ÂäõÂúñ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üî• Â∏ÇÂ†¥ÁÜ±ÂäõÂúñ</h3>
                <div class="chart-container">
                    <canvas id="marketHeatmapChart"></canvas>
                </div>
            </div>
        </div>

        <!-- È°ûËÇ°Ë°®Áèæ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- È°ûËÇ°Êº≤Ë∑åÊéíË°å -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä È°ûËÇ°Ë°®ÁèæÊéíË°å</h3>
                <div class="space-y-3">
                    {{#each sectorPerformance}}
                    <div class="flex items-center justify-between p-3 {{#if (gt this.changePercent 0)}}bg-green-50{{else}}bg-red-50{{/if}} rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 rounded-full {{#if (gt this.changePercent 0)}}bg-green-500{{else}}bg-red-500{{/if}}"></div>
                            <span class="font-medium text-gray-900">{{this.sector}}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold {{#if (gt this.changePercent 0)}}text-green-600{{else}}text-red-600{{/if}}">
                                {{#if (gt this.changePercent 0)}}+{{/if}}{{this.changePercent}}%
                            </span>
                            <p class="text-sm text-gray-600">{{this.avgPrice}}</p>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>

            <!-- Êàê‰∫§ÈáèÊéíË°å -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üí∞ Êàê‰∫§ÈáèÊéíË°å</h3>
                <div class="space-y-3">
                    {{#each volumeRanking}}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-bold text-gray-500 w-6">{{@index}}</span>
                            <div>
                                <p class="font-semibold text-gray-900">{{this.symbol}}</p>
                                <p class="text-sm text-gray-600">{{this.name}}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-900">{{formatVolume this.volume}}</p>
                            <p class="text-sm {{#if (gt this.changePercent 0)}}text-green-600{{else}}text-red-600{{/if}}">
                                {{#if (gt this.changePercent 0)}}+{{/if}}{{this.changePercent}}%
                            </p>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>

        <!-- ÊäÄË°ìÊåáÊ®ôÁµ±Ë®à -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h4 class="font-semibold text-gray-800 mb-3">RSI ÂàÜÂ∏É</h4>
                <div class="small-chart">
                    <canvas id="rsiDistributionChart"></canvas>
                </div>
                <div class="mt-3 grid grid-cols-3 gap-2 text-center">
                    <div>
                        <p class="text-sm text-gray-600">Ë∂ÖË≥£</p>
                        <p class="font-bold text-green-600">{{technicalStats.rsiOversold}}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Ê≠£Â∏∏</p>
                        <p class="font-bold text-blue-600">{{technicalStats.rsiNormal}}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Ë∂ÖË≤∑</p>
                        <p class="font-bold text-red-600">{{technicalStats.rsiOverbought}}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h4 class="font-semibold text-gray-800 mb-3">MACD ‰ø°Ëôü</h4>
                <div class="small-chart">
                    <canvas id="macdSignalChart"></canvas>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                    <div>
                        <p class="text-sm text-gray-600">ÈªÉÈáë‰∫§Âèâ</p>
                        <p class="font-bold text-green-600">{{technicalStats.macdBuy}}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Ê≠ª‰∫°‰∫§Âèâ</p>
                        <p class="font-bold text-red-600">{{technicalStats.macdSell}}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h4 class="font-semibold text-gray-800 mb-3">KD ÊåáÊ®ô</h4>
                <div class="small-chart">
                    <canvas id="kdSignalChart"></canvas>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-2 text-center">
                    <div>
                        <p class="text-sm text-gray-600">ÈªÉÈáë‰∫§Âèâ</p>
                        <p class="font-bold text-green-600">{{technicalStats.kdGolden}}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Ê≠ª‰∫°‰∫§Âèâ</p>
                        <p class="font-bold text-red-600">{{technicalStats.kdDeath}}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h4 class="font-semibold text-gray-800 mb-3">Â∏ÉÊûóÂ∏∂‰ΩçÁΩÆ</h4>
                <div class="small-chart">
                    <canvas id="bollingerChart"></canvas>
                </div>
                <div class="mt-3 grid grid-cols-3 gap-1 text-center">
                    <div>
                        <p class="text-xs text-gray-600">‰∏äËªå</p>
                        <p class="font-bold text-red-600">{{technicalStats.bollingerUpper}}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-600">‰∏≠Ëªå</p>
                        <p class="font-bold text-blue-600">{{technicalStats.bollingerMiddle}}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-600">‰∏ãËªå</p>
                        <p class="font-bold text-green-600">{{technicalStats.bollingerLower}}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊúÄÊñ∞Ë≥áË®ä -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">üì∞ ÊúÄÊñ∞Â∏ÇÂ†¥ÂãïÊÖã</h3>
                <span class="text-sm text-gray-600">Êõ¥Êñ∞ÊôÇÈñì: {{lastUpdate}}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">‰ªäÊó•ÁÑ¶Èªû</h4>
                    <ul class="space-y-2">
                        {{#each todayHighlights}}
                        <li class="text-sm text-gray-700">‚Ä¢ {{this}}</li>
                        {{/each}}
                    </ul>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-semibold text-green-800 mb-2">Âº∑Âã¢ËÇ°Á•®</h4>
                    <ul class="space-y-2">
                        {{#each strongStocks}}
                        <li class="text-sm text-gray-700 flex justify-between">
                            <span>{{this.symbol}}</span>
                            <span class="text-green-600">+{{this.changePercent}}%</span>
                        </li>
                        {{/each}}
                    </ul>
                </div>
                <div class="p-4 bg-red-50 rounded-lg">
                    <h4 class="font-semibold text-red-800 mb-2">Âº±Âã¢ËÇ°Á•®</h4>
                    <ul class="space-y-2">
                        {{#each weakStocks}}
                        <li class="text-sm text-gray-700 flex justify-between">
                            <span>{{this.symbol}}</span>
                            <span class="text-red-600">{{this.changePercent}}%</span>
                        </li>
                        {{/each}}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let isAutoRefresh = false;

        // Ê†ºÂºèÂåñÂÑÑÂÖÉ
        function formatBillion(value) {
            return (value / 100000000).toFixed(2);
        }

        // Ê†ºÂºèÂåñÊàê‰∫§Èáè
        function formatVolume(volume) {
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(2) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(2) + 'K';
            }
            return volume;
        }

        // Ëá™ÂãïÂà∑Êñ∞
        function autoRefresh() {
            const btn = document.getElementById('refreshBtn');
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                btn.textContent = 'üîÑ Ëá™ÂãïÂà∑Êñ∞: ÈóúÈñâ';
                btn.classList.remove('bg-green-700');
                btn.classList.add('bg-blue-700');
                isAutoRefresh = false;
            } else {
                autoRefreshInterval = setInterval(() => {
                    location.reload();
                }, 30000); // 30ÁßíÂà∑Êñ∞
                btn.textContent = 'üîÑ Ëá™ÂãïÂà∑Êñ∞: 30Áßí';
                btn.classList.remove('bg-blue-700');
                btn.classList.add('bg-green-700');
                isAutoRefresh = true;
            }
        }

        // ÊôÇÈñìÊ°ÜÊû∂ÊîπËÆä
        function changeTimeframe(timeframe) {
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500', 'text-white');
            });
            event.target.classList.add('active', 'bg-blue-500', 'text-white');
            
            // ÈáçÊñ∞ËºâÂÖ•Â∞çÊáâÊôÇÈñìÊ°ÜÊû∂ÁöÑÊï∏Êìö
            loadChartData(timeframe);
        }

        // ËºâÂÖ•ÂúñË°®Êï∏Êìö
        function loadChartData(timeframe) {
            fetch(`/api/chart/market-index?timeframe=${timeframe}`)
                .then(response => response.json())
                .then(data => {
                    updateMarketIndexChart(data);
                });
        }

        // ÂàùÂßãÂåñÊâÄÊúâÂúñË°®
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });

        function initializeCharts() {
            // ÂàùÂßãÂåñÂ∏ÇÂ†¥ÊåáÊï∏Âúñ
            initMarketIndexChart();
            
            // ÂàùÂßãÂåñÁÜ±ÂäõÂúñ
            initHeatmapChart();
            
            // ÂàùÂßãÂåñÊäÄË°ìÊåáÊ®ôÂàÜÂ∏ÉÂúñ
            initTechnicalDistributionCharts();
        }

        function initMarketIndexChart() {
            const ctx = document.getElementById('marketIndexChart').getContext('2d');
            fetch('/api/chart/market-index')
                .then(response => response.json())
                .then(data => {
                    new Chart(ctx, {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                });
        }

        function initHeatmapChart() {
            // Â∏ÇÂ†¥ÁÜ±ÂäõÂúñÂØ¶Áèæ
        }

        function initTechnicalDistributionCharts() {
            // RSIÂàÜÂ∏ÉÂúñ
            const rsiCtx = document.getElementById('rsiDistributionChart').getContext('2d');
            new Chart(rsiCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ë∂ÖË≥£', 'Ê≠£Â∏∏', 'Ë∂ÖË≤∑'],
                    datasets: [{
                        data: [{{technicalStats.rsiOversold}}, {{technicalStats.rsiNormal}}, {{technicalStats.rsiOverbought}}],
                        backgroundColor: ['#10b981', '#3b82f6', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // MACD‰ø°ËôüÂúñ
            const macdCtx = document.getElementById('macdSignalChart').getContext('2d');
            new Chart(macdCtx, {
                type: 'bar',
                data: {
                    labels: ['Ë≤∑ÈÄ≤', 'Ë≥£Âá∫'],
                    datasets: [{
                        data: [{{technicalStats.macdBuy}}, {{technicalStats.macdSell}}],
                        backgroundColor: ['#10b981', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>