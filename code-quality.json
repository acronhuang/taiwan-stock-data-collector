[{"filePath":"/Users/ming/Desktop/ch026/src/app.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/common/api-status.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/common/api-status.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/common/common.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/common/holiday.controller.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/common/holiday.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/common/security.utils.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":60,"column":10,"nodeType":"MemberExpression","endLine":60,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { BadRequestException } from '@nestjs/common';\n\n/**\n * é©—è­‰ MongoDB æŸ¥è©¢æ¢ä»¶ï¼Œé˜²æ­¢ç‰©ä»¶æ³¨å…¥æ”»æ“Š\n */\nexport function validateQueryConditions(\n  conditions: unknown,\n): Record<string, unknown> {\n  if (\n    !conditions ||\n    typeof conditions !== 'object' ||\n    Array.isArray(conditions)\n  ) {\n    throw new BadRequestException('Invalid query conditions');\n  }\n\n  const validConditions = conditions as Record<string, unknown>;\n\n  // æª¢æŸ¥æ˜¯å¦åŒ…å«æ½›åœ¨å±éšªçš„æ“ä½œç¬¦\n  const dangerousOperators = ['$where', '$eval', '$function'];\n  for (const key of Object.keys(validConditions)) {\n    if (dangerousOperators.includes(key)) {\n      throw new BadRequestException(`Dangerous operator not allowed: ${key}`);\n    }\n  }\n\n  return validConditions;\n}\n\n/**\n * é©—è­‰ MongoDB æ›´æ–°è³‡æ–™ï¼Œé˜²æ­¢ç‰©ä»¶æ³¨å…¥æ”»æ“Š\n */\nexport function validateUpdateData(data: unknown): Record<string, unknown> {\n  if (!data || typeof data !== 'object' || Array.isArray(data)) {\n    throw new BadRequestException('Invalid update data');\n  }\n\n  const validData = data as Record<string, unknown>;\n\n  // æª¢æŸ¥æ˜¯å¦åŒ…å«æ½›åœ¨å±éšªçš„æ“ä½œç¬¦\n  const dangerousOperators = ['$where', '$eval', '$function'];\n  for (const key of Object.keys(validData)) {\n    if (dangerousOperators.includes(key)) {\n      throw new BadRequestException(`Dangerous operator not allowed: ${key}`);\n    }\n  }\n\n  return validData;\n}\n\n/**\n * å®‰å…¨åœ°è¨ªå•ç‰©ä»¶å±¬æ€§\n */\nexport function safeGet<T = unknown>(obj: unknown, key: string): T | undefined {\n  if (!obj || typeof obj !== 'object' || Array.isArray(obj)) {\n    return undefined;\n  }\n\n  const safeObj = obj as Record<string, unknown>;\n  return safeObj[key] as T;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/fetch-october-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/main.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/market-stats/market-stats.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/market-stats/market-stats.repository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/market-stats/market-stats.schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/market-stats/market-stats.service.ts","messages":[{"ruleId":"max-params","severity":1,"message":"Constructor has too many parameters (7). Maximum allowed is 6.","line":16,"column":3,"nodeType":"FunctionExpression","messageId":"exceed","endLine":16,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable, Logger } from '@nestjs/common';\nimport { Cron } from '@nestjs/schedule';\nimport { DateTime } from 'luxon';\nimport { TaifexScraperService } from '../scraper/taifex-scraper.service';\nimport { TwseScraperService } from '../scraper/twse-scraper.service';\nimport { MarketStatsRepository } from './market-stats.repository';\nimport { TdccScraperService } from '../scraper/tdcc-scraper.service';\nimport { UsdtScraperService } from '../scraper/usdt-scraper.service';\nimport { HolidayService } from '../common/holiday.service';\nimport { ApiStatusService } from '../common/api-status.service';\n\n@Injectable()\nexport class MarketStatsService {\n  private readonly logger = new Logger(MarketStatsService.name);\n\n  constructor(\n    private readonly marketStatsRepository: MarketStatsRepository,\n    private readonly twseScraperService: TwseScraperService,\n    private readonly taifexScraperService: TaifexScraperService,\n    private readonly tdccScraperService: TdccScraperService,\n    private readonly usdtScraperService: UsdtScraperService,\n    private readonly holidayService: HolidayService,\n    private readonly apiStatusService: ApiStatusService,\n  ) {}\n\n  /**\n   * æ±ºå®šè¦æ›´æ–°çš„ç›®æ¨™æ—¥æœŸ\n   * è¦å‰‡ï¼š\n   * 1. å¦‚æœæ˜¯å·¥ä½œæ—¥ä¸”æ™‚é–“ >= 15:00 æˆ– >= 20:00ï¼Œä½¿ç”¨ç•¶æ—¥\n   * 2. å¦å‰‡ä½¿ç”¨ä¸Šä¸€å€‹å·¥ä½œæ—¥\n   */\n  private async getTargetUpdateDate(): Promise<string> {\n    const now = DateTime.local();\n    const today = now.toISODate();\n    const currentHour = now.hour;\n\n    // æª¢æŸ¥ä»Šå¤©æ˜¯å¦ç‚ºå·¥ä½œæ—¥\n    const isTodayWorkingDay = !(await this.holidayService.isHoliday(today));\n\n    // å¦‚æœä»Šå¤©æ˜¯å·¥ä½œæ—¥ä¸”æ™‚é–“å·²åˆ° 15:00 æˆ– 20:00\n    if (isTodayWorkingDay && (currentHour >= 15 || currentHour >= 20)) {\n      this.logger.log(\n        `ä½¿ç”¨ç•¶æ—¥ ${today} é€²è¡Œæ›´æ–° (ç•¶å‰æ™‚é–“: ${currentHour}:${now.minute\n          .toString()\n          .padStart(2, '0')})`,\n      );\n      return today;\n    }\n\n    // å¦å‰‡æ‰¾ä¸Šä¸€å€‹å·¥ä½œæ—¥\n    let targetDate = now.minus({ days: 1 });\n\n    // æŒçºŒå¾€å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°å·¥ä½œæ—¥\n    while (await this.holidayService.isHoliday(targetDate.toISODate())) {\n      targetDate = targetDate.minus({ days: 1 });\n    }\n\n    const targetDateStr = targetDate.toISODate();\n    this.logger.log(\n      `ä½¿ç”¨ä¸Šä¸€å€‹å·¥ä½œæ—¥ ${targetDateStr} é€²è¡Œæ›´æ–° (ç•¶å‰æ™‚é–“æœªåˆ°æ›´æ–°æ™‚é»æˆ–éå·¥ä½œæ—¥)`,\n    );\n    return targetDateStr;\n  }\n\n  /**\n   * æ‰‹å‹•è§¸ç™¼å®Œæ•´çš„å¤§ç›¤ç±Œç¢¼æ›´æ–°\n   */\n  async updateMarketStats(customDate?: string) {\n    const targetDate = customDate || (await this.getTargetUpdateDate());\n\n    // æå‰æª¢æŸ¥æ˜¯å¦ç‚ºä¼‘å‡æ—¥ï¼Œé¿å…åŸ·è¡Œæ‰€æœ‰å­ä»»å‹™\n    if (await this.holidayService.isHoliday(targetDate)) {\n      this.logger.log(`${targetDate} ç‚ºä¼‘å‡æ—¥ï¼Œè·³éæ‰€æœ‰å¤§ç›¤ç±Œç¢¼æ›´æ–°`);\n      return;\n    }\n\n    const updates = [\n      this.updateTaiex,\n      this.updateInstInvestorsTrades,\n      this.updateMarginTransactions,\n      this.updateFiniTxfNetOi,\n      this.updateFiniTxoNetOiValue,\n      this.updateLargeTradersTxfNetOi,\n      this.updateRetailMxfPosition,\n      this.updateTxoPutCallRatio,\n      this.updateUsdTwdRate,\n    ];\n\n    for (const update of updates) {\n      await update.call(this, targetDate);\n      await new Promise((resolve) => setTimeout(resolve, 2000));\n    }\n\n    Logger.log(`${targetDate} å¤§ç›¤ç±Œç¢¼å·²æ›´æ–°`, MarketStatsService.name);\n  }\n\n  /**\n   * æ™šä¸Š 8 é»å®Œæ•´å¤§ç›¤æ›´æ–°æ¯”å°\n   */\n  @Cron('0 0 20 * * 1-5') // é€±ä¸€åˆ°é€±äº”æ™šä¸Š 8 é»åŸ·è¡Œ\n  async scheduledFullUpdateEvening() {\n    this.logger.log('ğŸŒ™ é–‹å§‹åŸ·è¡Œæ™šä¸Š 20:00 å®Œæ•´å¤§ç›¤æ›´æ–°æ¯”å°');\n    await this.updateMarketStats();\n  }\n\n  @Cron('0 0 15 * * 1-5') // 15:00 - æ”¶é›†å¤§ç›¤åŠ æ¬ŠæŒ‡æ•¸å’Œæˆäº¤é‡\n  async updateTaiex(customDate?: string) {\n    const targetDate = customDate || (await this.getTargetUpdateDate());\n\n    // å…ˆæª¢æŸ¥ç›®æ¨™æ—¥æœŸæ˜¯å¦ç‚ºå‡æ—¥\n    if (await this.holidayService.isHoliday(targetDate)) {\n      Logger.log(\n        `${targetDate} é›†ä¸­å¸‚å ´åŠ æ¬ŠæŒ‡æ•¸: è·³éå‡æ—¥`,\n        MarketStatsService.name,\n      );\n      return;\n    }\n\n    const fetchedData = await this.twseScraperService.fetchMarketTrades({\n      date: targetDate,\n    });\n\n    if (!fetchedData) {\n      this.apiStatusService.logApiResult(\n        targetDate,\n        'TWSE_MARKET_TRADES',\n        'é›†ä¸­å¸‚å ´åŠ æ¬ŠæŒ‡æ•¸',\n        false,\n      );\n      return;\n    }\n\n    const dataToUpdate = {\n      date: fetchedData.date,\n      taiexPrice: fetchedData.price,\n      taiexChange: fetchedData.change,\n      taiexTradeValue: fetchedData.tradeValue,\n    };\n\n    const result = await this.marketStatsRepository.smartUpdate(dataToUpdate);\n\n    if (result.updated) {\n      const reasonText = result.reason === 'new_data' ? 'æ–°å¢' : 'æ›´æ–°';\n      Logger.log(\n        `${targetDate} é›†ä¸­å¸‚å ´åŠ æ¬ŠæŒ‡æ•¸: å·²${reasonText}`,\n        MarketStatsService.name,\n      );\n    } else {\n      Logger.log(\n        `${targetDate} é›†ä¸­å¸‚å ´åŠ æ¬ŠæŒ‡æ•¸: è³‡æ–™ç›¸åŒï¼Œè·³éæ›´æ–°`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('0 30 15 * * 1-5') // 15:30 - æ”¶é›†ä¸‰å¤§æ³•äººè²·è³£è¶…è³‡æ–™\n  async updateInstInvestorsTrades(customDate?: string) {\n    const targetDate = customDate || (await this.getTargetUpdateDate());\n\n    // å…ˆæª¢æŸ¥ç›®æ¨™æ—¥æœŸæ˜¯å¦ç‚ºå‡æ—¥\n    if (await this.holidayService.isHoliday(targetDate)) {\n      Logger.log(\n        `${targetDate} é›†ä¸­å¸‚å ´ä¸‰å¤§æ³•äººè²·è³£è¶…: è·³éå‡æ—¥`,\n        MarketStatsService.name,\n      );\n      return;\n    }\n\n    const fetchedData = await this.twseScraperService.fetchInstInvestorsTrades({\n      date: targetDate,\n    });\n\n    if (!fetchedData) {\n      this.apiStatusService.logApiResult(\n        targetDate,\n        'TWSE_BFI82U',\n        'é›†ä¸­å¸‚å ´ä¸‰å¤§æ³•äººè²·è³£è¶…',\n        false,\n      );\n      return;\n    }\n\n    const dataToUpdate = {\n      date: fetchedData.date,\n      finiNetBuySell: fetchedData.finiNetBuySell,\n      sitcNetBuySell: fetchedData.sitcNetBuySell,\n      dealersNetBuySell: fetchedData.dealersNetBuySell,\n    };\n\n    const result = await this.marketStatsRepository.smartUpdate(dataToUpdate);\n\n    if (result.updated) {\n      const reasonText = result.reason === 'new_data' ? 'æ–°å¢' : 'æ›´æ–°';\n      Logger.log(\n        `${targetDate} é›†ä¸­å¸‚å ´ä¸‰å¤§æ³•äººè²·è³£è¶…: å·²${reasonText}`,\n        MarketStatsService.name,\n      );\n    } else {\n      Logger.log(\n        `${targetDate} é›†ä¸­å¸‚å ´ä¸‰å¤§æ³•äººè²·è³£è¶…: è³‡æ–™ç›¸åŒï¼Œè·³éæ›´æ–°`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('0 30 21 * * *')\n  async updateMarginTransactions(date: string = DateTime.local().toISODate()) {\n    // å…ˆæª¢æŸ¥å‡æ—¥\n    if (await this.holidayService.isHoliday(date)) {\n      Logger.log(`${date} é›†ä¸­å¸‚å ´ä¿¡ç”¨äº¤æ˜“: è·³éå‡æ—¥`, MarketStatsService.name);\n      return;\n    }\n\n    const fetchedData = await this.twseScraperService.fetchMarginTransactions({\n      date,\n    });\n\n    if (!fetchedData) {\n      this.apiStatusService.logApiResult(\n        date,\n        'TWSE_MARGIN',\n        'é›†ä¸­å¸‚å ´ä¿¡ç”¨äº¤æ˜“',\n        false,\n      );\n      return;\n    }\n\n    const dataToUpdate = {\n      date: fetchedData.date,\n      marginBalance: fetchedData.marginBalance,\n      marginBalanceChange: fetchedData.marginBalanceChange,\n      marginBalanceValue: fetchedData.marginBalanceValue,\n      marginBalanceValueChange: fetchedData.marginBalanceValueChange,\n      shortBalance: fetchedData.shortBalance,\n      shortBalanceChange: fetchedData.shortBalanceChange,\n    };\n\n    const result = await this.marketStatsRepository.smartUpdate(dataToUpdate);\n\n    if (result.updated) {\n      const reasonText = result.reason === 'new_data' ? 'æ–°å¢' : 'æ›´æ–°';\n      Logger.log(\n        `${date} é›†ä¸­å¸‚å ´ä¿¡ç”¨äº¤æ˜“: å·²${reasonText}`,\n        MarketStatsService.name,\n      );\n    } else {\n      Logger.log(\n        `${date} é›†ä¸­å¸‚å ´ä¿¡ç”¨äº¤æ˜“: è³‡æ–™ç›¸åŒï¼Œè·³éæ›´æ–°`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('0 0 15 * * *')\n  async updateFiniTxfNetOi(date: string = DateTime.local().toISODate()) {\n    const updated = await this.taifexScraperService\n      .fetchInstInvestorsTxfTrades({ date })\n      .then(\n        (data) =>\n          data && {\n            date: data.date,\n            finiTxfNetOi: data.finiTxfNetOi,\n          },\n      )\n      .then(\n        (data) => data && this.marketStatsRepository.updateMarketStats(data),\n      );\n\n    if (updated) {\n      Logger.log(\n        `${date} å¤–è³‡è‡ºè‚¡æœŸè²¨æœªå¹³å€‰æ·¨å£æ•¸: å·²æ›´æ–°`,\n        MarketStatsService.name,\n      );\n    } else {\n      Logger.warn(\n        `${date} å¤–è³‡è‡ºè‚¡æœŸè²¨æœªå¹³å€‰æ·¨å£æ•¸: å°šç„¡è³‡æ–™æˆ–éäº¤æ˜“æ—¥`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('5 0 15 * * *')\n  async updateFiniTxoNetOiValue(date: string = DateTime.local().toISODate()) {\n    const updated = await this.taifexScraperService\n      .fetchInstInvestorsTxoTrades({ date })\n      .then(\n        (data) =>\n          data && {\n            date: data.date,\n            finiTxoCallsNetOiValue: data.finiTxoCallsNetOiValue,\n            finiTxoPutsNetOiValue: data.finiTxoPutsNetOiValue,\n          },\n      )\n      .then(\n        (data) => data && this.marketStatsRepository.updateMarketStats(data),\n      );\n\n    if (updated) {\n      Logger.log(\n        `${date} å¤–è³‡è‡ºæŒ‡é¸æ“‡æ¬Šæœªå¹³å€‰æ·¨é‡‘é¡: å·²æ›´æ–°`,\n        MarketStatsService.name,\n      );\n    } else {\n      Logger.warn(\n        `${date} å¤–è³‡è‡ºæŒ‡é¸æ“‡æ¬Šæœªå¹³å€‰æ·¨é‡‘é¡: å°šç„¡è³‡æ–™æˆ–éäº¤æ˜“æ—¥`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('10 0 15 * * *')\n  async updateLargeTradersTxfNetOi(\n    date: string = DateTime.local().toISODate(),\n  ) {\n    const updated = await this.taifexScraperService\n      .fetchLargeTradersTxfPosition({ date })\n      .then(\n        (data) =>\n          data && {\n            date: data.date,\n            topTenSpecificFrontMonthTxfNetOi:\n              data.topTenSpecificFrontMonthTxfNetOi,\n            topTenSpecificBackMonthsTxfNetOi:\n              data.topTenSpecificBackMonthsTxfNetOi,\n          },\n      )\n      .then(\n        (data) => data && this.marketStatsRepository.updateMarketStats(data),\n      );\n\n    if (updated) {\n      Logger.log(\n        `${date} åå¤§ç‰¹æ³•è‡ºè‚¡æœŸè²¨æœªå¹³å€‰æ·¨å£æ•¸: å·²æ›´æ–°`,\n        MarketStatsService.name,\n      );\n    } else {\n      Logger.warn(\n        `${date} åå¤§ç‰¹æ³•è‡ºè‚¡æœŸè²¨æœªå¹³å€‰æ·¨å£æ•¸: å°šç„¡è³‡æ–™æˆ–éäº¤æ˜“æ—¥`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('15 0 15 * * *')\n  async updateRetailMxfPosition(date: string = DateTime.local().toISODate()) {\n    const updated = await this.taifexScraperService\n      .fetchRetailMxfPosition({ date })\n      .then(\n        (data) =>\n          data && {\n            date: data.date,\n            retailMxfNetOi: data.retailMxfNetOi,\n            retailMxfLongShortRatio: data.retailMxfLongShortRatio,\n          },\n      )\n      .then(\n        (data) => data && this.marketStatsRepository.updateMarketStats(data),\n      );\n\n    if (updated) {\n      Logger.log(`${date} æ•£æˆ¶å°å°æ·¨éƒ¨ä½: å·²æ›´æ–°`, MarketStatsService.name);\n    } else {\n      Logger.warn(\n        `${date} æ•£æˆ¶å°å°æ·¨éƒ¨ä½: å°šç„¡è³‡æ–™æˆ–éäº¤æ˜“æ—¥`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('20 0 15 * * *')\n  async updateTxoPutCallRatio(date: string = DateTime.local().toISODate()) {\n    const updated = await this.taifexScraperService\n      .fetchTxoPutCallRatio({ date })\n      .then(\n        (data) =>\n          data && {\n            date: data.date,\n            txoPutCallRatio: data.txoPutCallRatio,\n          },\n      )\n      .then(\n        (data) => data && this.marketStatsRepository.updateMarketStats(data),\n      );\n\n    if (updated) {\n      Logger.log(\n        `${date} è‡ºæŒ‡é¸æ“‡æ¬Š Put/Call Ratio: å·²æ›´æ–°`,\n        MarketStatsService.name,\n      );\n    } else {\n      Logger.warn(\n        `${date} è‡ºæŒ‡é¸æ“‡æ¬Š Put/Call Ratio: å°šç„¡è³‡æ–™æˆ–éäº¤æ˜“æ—¥`,\n        MarketStatsService.name,\n      );\n    }\n  }\n\n  @Cron('0 0 17 * * *')\n  async updateUsdTwdRate(date: string = DateTime.local().toISODate()) {\n    const updated = await this.taifexScraperService\n      .fetchExchangeRates({ date })\n      .then(\n        (data) =>\n          data && {\n            date: data.date,\n            usdtwd: data.usdtwd,\n          },\n      )\n      .then(\n        (data) => data && this.marketStatsRepository.updateMarketStats(data),\n      );\n\n    if (updated) {\n      Logger.log(`${date} ç¾å…ƒå…Œæ–°è‡ºå¹£åŒ¯ç‡: å·²æ›´æ–°`, MarketStatsService.name);\n    } else {\n      Logger.warn(\n        `${date} ç¾å…ƒå…Œæ–°è‡ºå¹£åŒ¯ç‡: å°šç„¡è³‡æ–™æˆ–éäº¤æ˜“æ—¥`,\n        MarketStatsService.name,\n      );\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/mops-scraper.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/scraper.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/taifex-scraper.service.ts","messages":[{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'fetchLargeTradersTxoPosition' has too many lines (110). Maximum allowed is 80.","line":235,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":344,"endColumn":4}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { HttpService } from '@nestjs/axios';\nimport { Injectable } from '@nestjs/common';\nimport * as csvtojson from 'csvtojson';\nimport * as iconv from 'iconv-lite';\nimport * as numeral from 'numeral';\nimport { firstValueFrom } from 'rxjs';\nimport { DateTime } from 'luxon';\n\n@Injectable()\nexport class TaifexScraperService {\n  constructor(private httpService: HttpService) {}\n\n  async fetchInstInvestorsTxfTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n      commodityId: 'TXF',\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/futContractsDateDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [fields, dealers, sitc, fini] = json;\n    if (fields[0] !== 'æ—¥æœŸ') {\n      return null;\n    }\n\n    return {\n      date,\n      finiTxfNetOi: numeral(fini[13]).value(),\n      sitcTxfNetOi: numeral(sitc[13]).value(),\n      dealersTxfNetOi: numeral(dealers[13]).value(),\n    };\n  }\n\n  async fetchInstInvestorsTxoTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n      commodityId: 'TXO',\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/callsAndPutsDateDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [\n      fields,\n      dealersCalls,\n      sitcCalls,\n      finiCalls,\n      dealersPuts,\n      sitcPuts,\n      finiPuts,\n    ] = json;\n    if (fields[0] !== 'æ—¥æœŸ') {\n      return null;\n    }\n\n    return {\n      date,\n      finiTxoCallsNetOi: numeral(finiCalls[14]).value(),\n      finiTxoCallsNetOiValue: numeral(finiCalls[15]).value(),\n      sitcTxoCallsNetOi: numeral(sitcCalls[14]).value(),\n      sitcTxoCallsNetOiValue: numeral(sitcCalls[15]).value(),\n      dealersTxoCallsNetOi: numeral(dealersCalls[14]).value(),\n      dealersTxoCallsNetOiValue: numeral(dealersCalls[15]).value(),\n      finiTxoPutsNetOi: numeral(finiPuts[14]).value(),\n      finiTxoPutsNetOiValue: numeral(finiPuts[15]).value(),\n      sitcTxoPutsNetOi: numeral(sitcPuts[14]).value(),\n      sitcTxoPutsNetOiValue: numeral(sitcPuts[15]).value(),\n      dealersTxoPutsNetOi: numeral(dealersPuts[14]).value(),\n      dealersTxoPutsNetOiValue: numeral(dealersPuts[15]).value(),\n    };\n  }\n\n  private async fetchMxfMarketOi(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      down_type: '1',\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n      commodity_id: 'MTX',\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/futDataDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [fields, ...rows] = json;\n    if (fields[0] !== 'äº¤æ˜“æ—¥æœŸ') {\n      return null;\n    }\n\n    const mxfMarketOi = rows\n      .filter((row) => row[17] === 'ä¸€èˆ¬' && !row[18])\n      .reduce((oi, row) => oi + numeral(row[11]).value(), 0);\n\n    return { date, mxfMarketOi };\n  }\n\n  private async fetchInstInvestorsMxfOi(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n      commodityId: 'MXF',\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/futContractsDateDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [fields, dealers, sitc, fini] = json;\n    if (fields[0] !== 'æ—¥æœŸ') {\n      return null;\n    }\n\n    const dealersLongOi = numeral(dealers[9]).value();\n    const dealersShortOi = numeral(dealers[11]).value();\n    const sitcLongOi = numeral(sitc[9]).value();\n    const sitcShortOi = numeral(sitc[11]).value();\n    const finiLongOi = numeral(fini[9]).value();\n    const finiShortOi = numeral(fini[11]).value();\n    const instInvestorsMxfLongOi = dealersLongOi + sitcLongOi + finiLongOi;\n    const instInvestorsMxfShortOi = dealersShortOi + sitcShortOi + finiShortOi;\n\n    return { date, instInvestorsMxfLongOi, instInvestorsMxfShortOi };\n  }\n\n  async fetchRetailMxfPosition(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [fetchedMxfMarketOi, fetchedInstInvestorsMxfOi] = await Promise.all([\n      this.fetchMxfMarketOi(options),\n      this.fetchInstInvestorsMxfOi(options),\n    ]);\n    if (!fetchedMxfMarketOi || !fetchedInstInvestorsMxfOi) {\n      return null;\n    }\n\n    const { mxfMarketOi } = fetchedMxfMarketOi;\n    const { instInvestorsMxfLongOi, instInvestorsMxfShortOi } =\n      fetchedInstInvestorsMxfOi;\n    const retailMxfLongOi = mxfMarketOi - instInvestorsMxfLongOi;\n    const retailMxfShortOi = mxfMarketOi - instInvestorsMxfShortOi;\n    const retailMxfNetOi = retailMxfLongOi - retailMxfShortOi;\n    const retailMxfLongShortRatio =\n      Math.round((retailMxfNetOi / mxfMarketOi) * 10000) / 10000;\n\n    return {\n      date,\n      retailMxfLongOi,\n      retailMxfShortOi,\n      retailMxfNetOi,\n      retailMxfLongShortRatio,\n    };\n  }\n\n  async fetchLargeTradersTxfPosition(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/largeTraderFutDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [fields, ...rows] = json;\n    if (fields[0] !== 'æ—¥æœŸ') {\n      return null;\n    }\n\n    const txRows = rows.filter((row) => row[1] === 'TX');\n    const topTenFrontMonthTxfLongOi = numeral(txRows[2][7]).value();\n    const topTenFrontMonthTxfShortOi = numeral(txRows[2][8]).value();\n    const topTenFrontMonthTxfNetOi =\n      topTenFrontMonthTxfLongOi - topTenFrontMonthTxfShortOi;\n    const topTenSpecificFrontMonthTxfLongOi = numeral(txRows[3][7]).value();\n    const topTenSpecificFrontMonthTxfShortOi = numeral(txRows[3][8]).value();\n    const topTenSpecificFrontMonthTxfNetOi =\n      topTenSpecificFrontMonthTxfLongOi - topTenSpecificFrontMonthTxfShortOi;\n    const topTenNonspecificFrontMonthTxfNetOi =\n      topTenFrontMonthTxfNetOi - topTenSpecificFrontMonthTxfNetOi;\n    const topTenAllMonthsTxfLongOi = numeral(txRows[4][7]).value();\n    const topTenAllMonthsTxfShortOi = numeral(txRows[4][8]).value();\n    const topTenAllMonthsTxfNetOi =\n      topTenAllMonthsTxfLongOi - topTenAllMonthsTxfShortOi;\n    const topTenSpecificAllMonthsTxfLongOi = numeral(txRows[5][7]).value();\n    const topTenSpecificAllMonthsTxfShortOi = numeral(txRows[5][8]).value();\n    const topTenSpecificAllMonthsTxfNetOi =\n      topTenSpecificAllMonthsTxfLongOi - topTenSpecificAllMonthsTxfShortOi;\n    const topTenNonspecificAllMonthsTxfNetOi =\n      topTenAllMonthsTxfNetOi - topTenSpecificAllMonthsTxfNetOi;\n    const topTenSpecificBackMonthsTxfNetOi =\n      topTenSpecificAllMonthsTxfNetOi - topTenSpecificFrontMonthTxfNetOi;\n    const topTenNonspecificBackMonthsTxfNetOi =\n      topTenNonspecificAllMonthsTxfNetOi - topTenNonspecificFrontMonthTxfNetOi;\n    const allMonthsTxfMarketOi = numeral(txRows[4][9]).value();\n\n    return {\n      date,\n      topTenSpecificFrontMonthTxfNetOi,\n      topTenSpecificBackMonthsTxfNetOi,\n      topTenNonspecificFrontMonthTxfNetOi,\n      topTenNonspecificBackMonthsTxfNetOi,\n      allMonthsTxfMarketOi,\n    };\n  }\n\n  async fetchLargeTradersTxoPosition(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/largeTraderOptDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [fields, ...rows] = json;\n    if (fields[0] !== 'æ—¥æœŸ') {\n      return null;\n    }\n\n    const txoRows = rows.filter((row) => row[1] === 'TXO');\n    const topTenFrontMonthTxoCallsLongOi = numeral(txoRows[2][8]).value();\n    const topTenFrontMonthTxoCallsShortOi = numeral(txoRows[2][9]).value();\n    const topTenFrontMonthTxoCallsNetOi =\n      topTenFrontMonthTxoCallsLongOi - topTenFrontMonthTxoCallsShortOi;\n    const topTenSpecificFrontMonthTxoCallsLongOi = numeral(\n      txoRows[3][8],\n    ).value();\n    const topTenSpecificFrontMonthTxoCallsShortOi = numeral(\n      txoRows[3][9],\n    ).value();\n    const topTenSpecificFrontMonthTxoCallsNetOi =\n      topTenSpecificFrontMonthTxoCallsLongOi -\n      topTenSpecificFrontMonthTxoCallsShortOi;\n    const topTenNonspecificFrontMonthTxoCallsNetOi =\n      topTenFrontMonthTxoCallsNetOi - topTenSpecificFrontMonthTxoCallsNetOi;\n    const topTenAllMonthsTxoCallsLongOi = numeral(txoRows[4][8]).value();\n    const topTenAllMonthsTxoCallsShortOi = numeral(txoRows[4][9]).value();\n    const topTenAllMonthsTxoCallsNetOi =\n      topTenAllMonthsTxoCallsLongOi - topTenAllMonthsTxoCallsShortOi;\n    const topTenSpecificAllMonthsTxoCallsLongOi = numeral(\n      txoRows[5][8],\n    ).value();\n    const topTenSpecificAllMonthsTxoCallsShortOi = numeral(\n      txoRows[5][9],\n    ).value();\n    const topTenSpecificAllMonthsTxoCallsNetOi =\n      topTenSpecificAllMonthsTxoCallsLongOi -\n      topTenSpecificAllMonthsTxoCallsShortOi;\n    const topTenNonspecificAllMonthsTxoCallsNetOi =\n      topTenAllMonthsTxoCallsNetOi - topTenSpecificAllMonthsTxoCallsNetOi;\n    const topTenSpecificBackMonthsTxoCallsNetOi =\n      topTenSpecificAllMonthsTxoCallsNetOi -\n      topTenSpecificFrontMonthTxoCallsNetOi;\n    const topTenNonspecificBackMonthsTxoCallsNetOi =\n      topTenNonspecificAllMonthsTxoCallsNetOi -\n      topTenNonspecificFrontMonthTxoCallsNetOi;\n    const allMonthsTxoCallsMarketOi = numeral(txoRows[4][10]).value();\n    const topTenFrontMonthTxoPutsLongOi = numeral(txoRows[8][8]).value();\n    const topTenFrontMonthTxoPutsShortOi = numeral(txoRows[8][9]).value();\n    const topTenFrontMonthTxoPutsNetOi =\n      topTenFrontMonthTxoPutsLongOi - topTenFrontMonthTxoPutsShortOi;\n    const topTenSpecificFrontMonthTxoPutsLongOi = numeral(\n      txoRows[9][8],\n    ).value();\n    const topTenSpecificFrontMonthTxoPutsShortOi = numeral(\n      txoRows[9][9],\n    ).value();\n    const topTenSpecificFrontMonthTxoPutsNetOi =\n      topTenSpecificFrontMonthTxoPutsLongOi -\n      topTenSpecificFrontMonthTxoPutsShortOi;\n    const topTenNonspecificFrontMonthTxoPutsNetOi =\n      topTenFrontMonthTxoPutsNetOi - topTenSpecificFrontMonthTxoPutsNetOi;\n    const topTenAllMonthsTxoPutsLongOi = numeral(txoRows[10][8]).value();\n    const topTenAllMonthsTxoPutsShortOi = numeral(txoRows[10][9]).value();\n    const topTenAllMonthsTxoPutsNetOi =\n      topTenAllMonthsTxoPutsLongOi - topTenAllMonthsTxoPutsShortOi;\n    const topTenSpecificAllMonthsTxoPutsLongOi = numeral(\n      txoRows[11][8],\n    ).value();\n    const topTenSpecificAllMonthsTxoPutsShortOi = numeral(\n      txoRows[11][9],\n    ).value();\n    const topTenSpecificAllMonthsTxoPutsNetOi =\n      topTenSpecificAllMonthsTxoPutsLongOi -\n      topTenSpecificAllMonthsTxoPutsShortOi;\n    const topTenNonspecificAllMonthsTxoPutsNetOi =\n      topTenAllMonthsTxoPutsNetOi - topTenSpecificAllMonthsTxoPutsNetOi;\n    const topTenSpecificBackMonthsTxoPutsNetOi =\n      topTenSpecificAllMonthsTxoPutsNetOi -\n      topTenSpecificFrontMonthTxoPutsNetOi;\n    const topTenNonspecificBackMonthsTxoPutsNetOi =\n      topTenNonspecificAllMonthsTxoPutsNetOi -\n      topTenNonspecificFrontMonthTxoPutsNetOi;\n    const allMonthsTxoPutsMarketOi = numeral(txoRows[10][10]).value();\n\n    return {\n      date,\n      topTenSpecificFrontMonthTxoCallsNetOi,\n      topTenSpecificBackMonthsTxoCallsNetOi,\n      topTenNonspecificFrontMonthTxoCallsNetOi,\n      topTenNonspecificBackMonthsTxoCallsNetOi,\n      allMonthsTxoCallsMarketOi,\n      topTenSpecificFrontMonthTxoPutsNetOi,\n      topTenSpecificBackMonthsTxoPutsNetOi,\n      topTenNonspecificFrontMonthTxoPutsNetOi,\n      topTenNonspecificBackMonthsTxoPutsNetOi,\n      allMonthsTxoPutsMarketOi,\n    };\n  }\n\n  async fetchTxoPutCallRatio(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/pcRatioDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [, row] = json;\n    if (!row) {\n      return null;\n    }\n    if (DateTime.fromString(row[0], 'yyyy/MM/dd').toISODate() !== date) {\n      return null;\n    }\n\n    const txoPutCallRatio = numeral(row[6]).divide(100).value();\n\n    return { date, txoPutCallRatio };\n  }\n\n  async fetchExchangeRates(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const queryDate = DateTime.fromISO(date).toFormat('yyyy/MM/dd');\n    const form = new URLSearchParams({\n      queryStartDate: queryDate,\n      queryEndDate: queryDate,\n    });\n    const url = 'https://www.taifex.com.tw/cht/3/dailyFXRateDown';\n\n    const response = await firstValueFrom(\n      this.httpService.post(url, form, { responseType: 'arraybuffer' }),\n    );\n    const json = await csvtojson({ noheader: true, output: 'csv' }).fromString(\n      iconv.decode(response.data, 'big5'),\n    );\n    const [fields, row] = json;\n    if (fields[0] !== 'æ—¥æœŸ') {\n      return null;\n    }\n\n    const [usdtwd] = row.slice(1).map((data) => numeral(data).value());\n\n    return { date, usdtwd };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/tdcc-scraper.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/tpex-scraper.service.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":252,"column":17,"nodeType":"MemberExpression","endLine":252,"endColumn":39},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":253,"column":15,"nodeType":"MemberExpression","endLine":253,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":368,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":368,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12236,12239],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12236,12239],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":393,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":393,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13198,13201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13198,13201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { HttpService } from '@nestjs/axios';\nimport { Injectable } from '@nestjs/common';\nimport * as _ from 'lodash';\nimport { DateTime } from 'luxon';\nimport * as numeral from 'numeral';\nimport { firstValueFrom } from 'rxjs';\n\n@Injectable()\nexport class TpexScraperService {\n  constructor(private httpService: HttpService) {}\n\n  async fetchMarketTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/aftertrading/daily_trading_index/st41_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    // æ–°çš„ API çµæ§‹ä½¿ç”¨ tables è€Œä¸æ˜¯ iTotalRecords/aaData\n    const json = response.data.tables?.[0]?.totalCount > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    return json.tables[0].data\n      .map((row) => {\n        const [year, month, day] = row[0].split('/');\n        return {\n          date: `${+year + 1911}-${month.padStart(2, '0')}-${day.padStart(\n            2,\n            '0',\n          )}`,\n          tradeVolume: numeral(row[1]).value(),\n          tradeValue: numeral(row[2]).value(),\n          transaction: numeral(row[3]).value(),\n          price: numeral(row[4]).value(),\n          change: numeral(row[5]).value(),\n        };\n      })\n      .find((data) => data.date === date);\n  }\n\n  async fetchMarketBreadth(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/aftertrading/market_highlight/highlight_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    // æ–°çš„ API çµæ§‹ä½¿ç”¨ tables\n    const json = response.data.tables?.[0]?.data?.length > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    // æ–°çµæ§‹ï¼šdata[0] = [ä¸Šæ«ƒå®¶æ•¸, ç¸½è³‡æœ¬é¡, ç¸½å¸‚å€¼, æˆäº¤å€¼, æˆäº¤è‚¡æ•¸, æ”¶å¸‚æŒ‡æ•¸, æŒ‡æ•¸æ¼²è·Œ, ä¸Šæ¼²å®¶æ•¸, æ¼²åœ, ä¸‹è·Œ, è·Œåœ, å¹³ç›¤, æœªæˆäº¤]\n    const row = json.tables[0].data[0];\n    return {\n      date,\n      up: numeral(row[7]).value(),\n      limitUp: numeral(row[8]).value(),\n      down: numeral(row[9]).value(),\n      limitDown: numeral(row[10]).value(),\n      unchanged: numeral(row[11]).value(),\n      unmatched: numeral(row[12]).value(),\n    };\n  }\n\n  async fetchInstInvestorsTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      t: 'D',\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/3insti/3insti_summary/3itrdsum_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    // æ–°çš„ API çµæ§‹ä½¿ç”¨ tables\n    const json = response.data.tables?.[0]?.data?.length > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    // æ–°çµæ§‹ï¼šdata é™£åˆ—åŒ…å«å„æ³•äººçš„è²·è³£è¶…è³‡æ–™\n    // [0] = å¤–è³‡åŠé™¸è³‡åˆè¨ˆ, [3] = æŠ•ä¿¡, [4] = è‡ªç‡Ÿå•†åˆè¨ˆ\n    const data = json.tables[0].data;\n\n    return {\n      date,\n      finiNetBuySell: numeral(data[0][3]).value(), // å¤–è³‡è²·è³£è¶…\n      sitcNetBuySell: numeral(data[3][3]).value(), // æŠ•ä¿¡è²·è³£è¶…\n      dealersBuySell: numeral(data[4][3]).value(), // è‡ªç‡Ÿå•†è²·è³£è¶…\n    };\n  }\n\n  async fetchMarginTransactions(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/margin_trading/margin_balance/margin_bal_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.iTotalRecords > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const data = [...json.tfootData_one, ...json.tfootData_two]\n      .map((row) => numeral(row).value())\n      .filter((row) => row);\n\n    return {\n      date,\n      marginBalance: data[4],\n      marginBalanceChange: data[4] - data[0],\n      marginBalanceValue: data[14],\n      marginBalanceValueChange: data[14] - data[10],\n      shortBalance: data[9],\n      shortBalanceChange: data[9] - data[5],\n    };\n  }\n\n  async fetchIndicesQuotes(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      o: 'json',\n    });\n    // ä½¿ç”¨å¸‚å ´ç„¦é»æŒ‡æ¨™ API æ›¿ä»£å·²å¤±æ•ˆçš„æ¯åˆ†é˜æŒ‡æ•¸ API\n    const url = `https://www.tpex.org.tw/web/stock/aftertrading/market_highlight/highlight_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    // æ–°çš„ API çµæ§‹ä½¿ç”¨ tables\n    const json = response.data.tables?.[0]?.data?.length > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    // å¾å¸‚å ´ç„¦é»æŒ‡æ¨™æå–æ«ƒè²·æŒ‡æ•¸è³‡æ–™\n    // æ¬„ä½ï¼š[ä¸Šæ«ƒå®¶æ•¸, ç¸½è³‡æœ¬é¡, ç¸½å¸‚å€¼, æˆäº¤å€¼, æˆäº¤è‚¡æ•¸, æ”¶å¸‚æŒ‡æ•¸, æŒ‡æ•¸æ¼²è·Œ, ä¸Šæ¼²å®¶æ•¸, ...]\n    const row = json.tables[0].data[0];\n\n    // é©—è­‰è³‡æ–™å®Œæ•´æ€§\n    if (!row || row.length < 7) {\n      return null;\n    }\n\n    const closePrice = numeral(row[5]).value(); // æ”¶å¸‚æŒ‡æ•¸\n    const change = numeral(row[6]).value(); // æŒ‡æ•¸æ¼²è·Œ\n\n    // é©—è­‰æ•¸å€¼æœ‰æ•ˆæ€§\n    if (closePrice === null || change === null || closePrice <= 0) {\n      return null;\n    }\n\n    // è¨ˆç®—é–‹ç›¤åƒ¹ï¼ˆæ”¶ç›¤åƒ¹ - æ¼²è·Œï¼‰\n    const openPrice = numeral(closePrice).subtract(change).value();\n\n    // ç¢ºä¿é–‹ç›¤åƒ¹ç‚ºæ­£å€¼\n    if (openPrice <= 0) {\n      return null;\n    }\n\n    // ç”±æ–¼é€™å€‹ API åªæä¾›æ”¶ç›¤è³‡æ–™ï¼Œæˆ‘å€‘åªèƒ½è¿”å›æ«ƒè²·æŒ‡æ•¸\n    return [\n      {\n        date,\n        symbol: 'IX0043',\n        name: 'æ«ƒè²·æŒ‡æ•¸',\n        openPrice: openPrice,\n        highPrice: Math.max(openPrice, closePrice), // å–é–‹ç›¤å’Œæ”¶ç›¤çš„è¼ƒé«˜è€…\n        lowPrice: Math.min(openPrice, closePrice), // å–é–‹ç›¤å’Œæ”¶ç›¤çš„è¼ƒä½è€…\n        closePrice: closePrice,\n        change: change,\n        changePercent:\n          change !== 0\n            ? +numeral(change).divide(openPrice).multiply(100).format('0.00')\n            : 0,\n      },\n    ];\n  }\n\n  async fetchIndicesTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/historical/trading_vol_ratio/sectr_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    // æ–°çš„ API çµæ§‹ä½¿ç”¨ tables\n    const json = response.data.tables?.[0]?.data?.length > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const sectorMappings = {\n      å…‰é›»æ¥­: { symbol: 'IX0055', name: 'æ«ƒè²·å…‰é›»æ¥­é¡æŒ‡æ•¸' },\n      å…¶ä»–: { symbol: 'IX0100', name: 'æ«ƒè²·å…¶ä»–é¡æŒ‡æ•¸' },\n      å…¶ä»–é›»å­æ¥­: { symbol: 'IX0099', name: 'æ«ƒè²·å…¶ä»–é›»å­é¡æŒ‡æ•¸' },\n      åŒ–å­¸å·¥æ¥­: { symbol: 'IX0051', name: 'æ«ƒè²·åŒ–å·¥é¡æŒ‡æ•¸' },\n      åŠå°é«”æ¥­: { symbol: 'IX0053', name: 'æ«ƒè²·åŠå°é«”é¡æŒ‡æ•¸' },\n      å±…å®¶ç”Ÿæ´»: { symbol: 'IX0191', name: 'æ«ƒè²·å±…å®¶ç”Ÿæ´»é¡æŒ‡æ•¸' },\n      å»ºæç‡Ÿé€ : { symbol: 'IX0048', name: 'æ«ƒè²·ç‡Ÿå»ºé¡æŒ‡æ•¸' },\n      æ•¸ä½é›²ç«¯: { symbol: 'IX0190', name: 'æ«ƒè²·æ•¸ä½é›²ç«¯é¡æŒ‡æ•¸' },\n      æ–‡åŒ–å‰µæ„æ¥­: { symbol: 'IX0075', name: 'æ«ƒè²·æ–‡åŒ–å‰µæ„æ¥­é¡æŒ‡æ•¸' },\n      ç”ŸæŠ€é†«ç™‚: { symbol: 'IX0052', name: 'æ«ƒè²·ç”ŸæŠ€é†«ç™‚é¡æŒ‡æ•¸' },\n      ç´¡ç¹”çº–ç¶­: { symbol: 'IX0044', name: 'æ«ƒè²·ç´¡çº–é¡æŒ‡æ•¸' },\n      ç¶ èƒ½ç’°ä¿: { symbol: 'IX0189', name: 'æ«ƒè²·ç¶ èƒ½ç’°ä¿é¡æŒ‡æ•¸' },\n      èˆªé‹æ¥­: { symbol: 'IX0049', name: 'æ«ƒè²·èˆªé‹é¡æŒ‡æ•¸' },\n      è§€å…‰é¤æ—…: { symbol: 'IX0050', name: 'æ«ƒè²·è§€å…‰é¡æŒ‡æ•¸' },\n      è³‡è¨Šæœå‹™æ¥­: { symbol: 'IX0059', name: 'æ«ƒè²·è³‡è¨Šæœå‹™é¡æŒ‡æ•¸' },\n      é€šä¿¡ç¶²è·¯æ¥­: { symbol: 'IX0056', name: 'æ«ƒè²·é€šä¿¡ç¶²è·¯é¡æŒ‡æ•¸' },\n      é‹¼éµå·¥æ¥­: { symbol: 'IX0046', name: 'æ«ƒè²·é‹¼éµé¡æŒ‡æ•¸' },\n      é›»å­é€šè·¯æ¥­: { symbol: 'IX0058', name: 'æ«ƒè²·é›»å­é€šè·¯é¡æŒ‡æ•¸' },\n      é›»å­é›¶çµ„ä»¶æ¥­: { symbol: 'IX0057', name: 'æ«ƒè²·é›»å­é›¶çµ„ä»¶é¡æŒ‡æ•¸' },\n      é›»æ©Ÿæ©Ÿæ¢°: { symbol: 'IX0045', name: 'æ«ƒè²·æ©Ÿæ¢°é¡æŒ‡æ•¸' },\n      é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­: { symbol: 'IX0054', name: 'æ«ƒè²·é›»è…¦åŠé€±é‚Šé¡æŒ‡æ•¸' },\n    };\n\n    const electronics = [\n      'IX0053',\n      'IX0054',\n      'IX0055',\n      'IX0056',\n      'IX0057',\n      'IX0058',\n      'IX0059',\n      'IX0099',\n    ];\n\n    // æ–°çµæ§‹ï¼štables[0].data åŒ…å«é¡è‚¡è³‡æ–™\n    // æ¬„ä½ï¼š[é¡è‚¡åç¨±, æˆäº¤é‡‘é¡(å…ƒ), æˆäº¤æ¯”é‡(%), æˆäº¤è‚¡æ•¸, æˆäº¤æ¯”é‡(%)]\n    const data = json.tables[0].data.map((row) => {\n      const [sector, tradeValue, tradeWeight] = row;\n      return {\n        date,\n        symbol: sectorMappings[sector]?.symbol,\n        name: sectorMappings[sector]?.name,\n        tradeValue: numeral(tradeValue).value(),\n        tradeWeight: numeral(tradeWeight).value(),\n      };\n    });\n\n    const [electronic] = _(data)\n      .filter((data) => electronics.includes(data.symbol))\n      .groupBy((_) => 'IX0047')\n      .map((data, symbol) => ({\n        date,\n        symbol,\n        name: 'æ«ƒè²·é›»å­é¡æŒ‡æ•¸',\n        tradeValue: _.sumBy(data, 'tradeValue'),\n        tradeWeight: +numeral(_.sumBy(data, 'tradeWeight')).format('0.00'),\n      }))\n      .value();\n\n    return [...data, electronic].filter((index) => index.symbol);\n  }\n\n  async fetchEquitiesQuotes(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    // æ–°çš„ API çµæ§‹ä½¿ç”¨ tables\n    const json = response.data.tables?.[0]?.data?.length > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const isWarrant = (symbol: string) => {\n      const rules = [\n        /^7[0-3][0-9][0-9][0-9][0-9]$/,\n        /^7[0-3][0-9][0-9][0-9]P$/,\n        /^7[0-3][0-9][0-9][0-9]F$/,\n        /^7[0-3][0-9][0-9][0-9]Q$/,\n        /^7[0-3][0-9][0-9][0-9]C$/,\n        /^7[0-3][0-9][0-9][0-9]B$/,\n        /^7[0-3][0-9][0-9][0-9]X$/,\n        /^7[0-3][0-9][0-9][0-9]Y$/,\n      ];\n      return rules.some((regex) => regex.test(symbol));\n    };\n\n    // æ–°çµæ§‹ï¼štables[0].data åŒ…å«å€‹è‚¡è³‡æ–™\n    // æ¬„ä½ï¼š[ä»£è™Ÿ, åç¨±, æ”¶ç›¤, æ¼²è·Œ, é–‹ç›¤, æœ€é«˜, æœ€ä½, å‡åƒ¹, æˆäº¤è‚¡æ•¸, æˆäº¤é‡‘é¡, æˆäº¤ç­†æ•¸, ...]\n    return json.tables[0].data\n      .filter((row) => !isWarrant(row[0]))\n      .map((row) => {\n        const [\n          symbol,\n          name,\n          closePrice,\n          change,\n          openPrice,\n          highPrice,\n          lowPrice,\n          ,\n          tradeVolume,\n          tradeValue,\n          transaction,\n        ] = row;\n        const data: Record<string, string | number | null> = {\n          date,\n          symbol,\n          name,\n        };\n        data.openPrice = numeral(openPrice).value();\n        data.highPrice = numeral(highPrice).value();\n        data.lowPrice = numeral(lowPrice).value();\n        data.closePrice = numeral(closePrice).value();\n        data.tradeVolume = numeral(tradeVolume).value();\n        data.tradeValue = numeral(tradeValue).value();\n        data.transaction = numeral(transaction).value();\n        data.change = numeral(change).value();\n        data.changePercent =\n          data.closePrice && data.change !== null\n            ? +numeral(data.change as number)\n                .divide((data.closePrice as number) - (data.change as number))\n                .multiply(100)\n                .format('0.00')\n            : 0;\n        return data;\n      });\n  }\n\n  async fetchEquitiesInstInvestorsTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      se: 'EW',\n      t: 'D',\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/3insti/daily_trade/3itrade_hedge_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    // æ–°çš„ API çµæ§‹ä½¿ç”¨ tables\n    const json = response.data.tables?.[0]?.data?.length > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    // æ–°çµæ§‹ï¼štables[0].data åŒ…å«å€‹è‚¡æ³•äººé€²å‡ºè³‡æ–™\n    // æ¬„ä½é †åº: [0]ä»£è™Ÿ [1]åç¨± [2-4]å¤–è³‡ [5-7]æŠ•ä¿¡ [8-10]å¤–è³‡+æŠ•ä¿¡ [11-13]è‡ªç‡Ÿ(è‡ªè¡Œ) [14-16]è‡ªç‡Ÿ(é¿éšª) [17-19]åˆ¸å•† [20-22]è‡ªç‡Ÿ+åˆ¸å•† [23]ä¸‰å¤§æ³•äººåˆè¨ˆ\n    return json.tables[0].data.map((row) => {\n      const [symbol, name, ...values] = row;\n      const data: Record<string, any> = { date, symbol, name };\n      data.finiNetBuySell = numeral(values[2]).value(); // å¤–è³‡è²·è³£è¶… [4]\n      data.sitcNetBuySell = numeral(values[5]).value(); // æŠ•ä¿¡è²·è³£è¶… [7]\n      data.dealersNetBuySell = numeral(values[18]).value(); // è‡ªç‡Ÿ+åˆ¸å•†è²·è³£è¶… [22]\n      return data;\n    });\n  }\n\n  async fetchEquitiesValues(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const [year, month, day] = date.split('-');\n    const query = new URLSearchParams({\n      d: `${+year - 1911}/${month}/${day}`,\n      o: 'json',\n    });\n    const url = `https://www.tpex.org.tw/web/stock/aftertrading/peratio_analysis/pera_result.php?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.iTotalRecords > 0 && response.data;\n    if (!json) {\n      return null;\n    }\n\n    return json.aaData.map((row) => {\n      const [symbol, name, ...values] = row;\n      const data: Record<string, any> = { date, symbol, name };\n      data.peRatio = numeral(values[0]).value();\n      data.pbRatio = numeral(values[4]).value();\n      data.dividendYield = numeral(values[3]).value();\n      data.dividendYear = numeral(values[2]).value();\n      return data;\n    });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/twse-scraper.service.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":21,"column":28,"nodeType":"MemberExpression","endLine":21,"endColumn":39},{"ruleId":"max-lines-per-function","severity":1,"message":"Async method 'fetchIndicesQuotes' has too many lines (85). Maximum allowed is 80.","line":161,"column":3,"nodeType":"MethodDefinition","messageId":"exceed","endLine":245,"endColumn":4},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":221,"column":17,"nodeType":"MemberExpression","endLine":221,"endColumn":27},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":222,"column":15,"nodeType":"MemberExpression","endLine":222,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":232,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7797,7800],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7797,7800],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":303,"column":32,"nodeType":"MemberExpression","endLine":303,"endColumn":42},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":304,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":304,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10574,10577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10574,10577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":332,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":332,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11529,11532],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11529,11532],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":370,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":370,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12939,12942],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12939,12942],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":396,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":396,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13900,13903],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13900,13903],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { HttpService } from '@nestjs/axios';\nimport { Injectable } from '@nestjs/common';\nimport * as cheerio from 'cheerio';\nimport * as iconv from 'iconv-lite';\nimport * as _ from 'lodash';\nimport { DateTime } from 'luxon';\nimport * as numeral from 'numeral';\nimport { firstValueFrom } from 'rxjs';\n\n@Injectable()\nexport class TwseScraperService {\n  constructor(private httpService: HttpService) {}\n\n  async fetchListedStocks(options?: { market: 'TSE' | 'OTC' }) {\n    const market = options?.market ?? 'TSE';\n    const url = {\n      TSE: 'https://isin.twse.com.tw/isin/class_main.jsp?market=1&issuetype=1',\n      OTC: 'https://isin.twse.com.tw/isin/class_main.jsp?market=2&issuetype=4',\n    };\n    const response = await firstValueFrom(\n      this.httpService.get(url[market], { responseType: 'arraybuffer' }),\n    );\n    const page = iconv.decode(response.data, 'big5');\n    const $ = cheerio.load(page);\n\n    return $('.h4 tr')\n      .slice(1)\n      .map((_, el) => {\n        const td = $(el).find('td');\n        return {\n          symbol: td.eq(2).text().trim(),\n          name: td.eq(3).text().trim(),\n          market: td.eq(4).text().trim(),\n          industry: td.eq(6).text().trim(),\n        };\n      })\n      .toArray();\n  }\n\n  async fetchMarketTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/afterTrading/FMTQIK?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    return json.data\n      .map((row) => {\n        const [year, month, day] = row[0].split('/');\n        return {\n          date: `${+year + 1911}-${month.padStart(2, '0')}-${day.padStart(\n            2,\n            '0',\n          )}`,\n          tradeVolume: numeral(row[1]).value(),\n          tradeValue: numeral(row[2]).value(),\n          transaction: numeral(row[3]).value(),\n          price: numeral(row[4]).value(),\n          change: numeral(row[5]).value(),\n        };\n      })\n      .find((data) => data.date === date);\n  }\n\n  async fetchMarketBreadth(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/afterTrading/MI_INDEX?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const raw = json.tables[7].data.map((row) => row[2]);\n    const [up, limitUp] = raw[0].replace(')', '').split('(');\n    const [down, limitDown] = raw[1].replace(')', '').split('(');\n    const [unchanged, unmatched, notApplicable] = raw.slice(2);\n\n    return {\n      date,\n      up: numeral(up).value(),\n      limitUp: numeral(limitUp).value(),\n      down: numeral(down).value(),\n      limitDown: numeral(limitDown).value(),\n      unchanged: numeral(unchanged).value(),\n      unmatched: numeral(unmatched).value() + numeral(notApplicable).value(),\n    };\n  }\n\n  async fetchInstInvestorsTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      dayDate: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      type: 'day',\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/fund/BFI82U?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const data = json.data\n      .map((row) => row.slice(1))\n      .flat()\n      .map((row) => numeral(row).value());\n\n    return {\n      date,\n      finiNetBuySell: data[11] + data[14],\n      sitcNetBuySell: data[8],\n      dealersNetBuySell: data[2] + data[5],\n    };\n  }\n\n  async fetchMarginTransactions(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      selectType: 'MS',\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/marginTrading/MI_MARGN?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const data = json.tables[0].data\n      .map((data) => data.slice(1))\n      .flat()\n      .map((data) => numeral(data).value());\n\n    return {\n      date,\n      marginBalance: data[4],\n      marginBalanceChange: data[4] - data[3],\n      marginBalanceValue: data[14],\n      marginBalanceValueChange: data[14] - data[13],\n      shortBalance: data[9],\n      shortBalanceChange: data[9] - data[8],\n    };\n  }\n\n  async fetchIndicesQuotes(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/TAIEX/MI_5MINS_INDEX?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const indices = [\n      { symbol: 'IX0001', name: 'ç™¼è¡Œé‡åŠ æ¬Šè‚¡åƒ¹æŒ‡æ•¸' },\n      { symbol: 'IX0007', name: 'æœªå«é‡‘èä¿éšªè‚¡æŒ‡æ•¸' },\n      { symbol: 'IX0008', name: 'æœªå«é›»å­è‚¡æŒ‡æ•¸' },\n      { symbol: 'IX0009', name: 'æœªå«é‡‘èé›»å­è‚¡æŒ‡æ•¸' },\n      { symbol: 'IX0010', name: 'æ°´æ³¥é¡æŒ‡æ•¸' },\n      { symbol: 'IX0011', name: 'é£Ÿå“é¡æŒ‡æ•¸' },\n      { symbol: 'IX0012', name: 'å¡‘è† é¡æŒ‡æ•¸' },\n      { symbol: 'IX0016', name: 'ç´¡ç¹”çº–ç¶­é¡æŒ‡æ•¸' },\n      { symbol: 'IX0017', name: 'é›»æ©Ÿæ©Ÿæ¢°é¡æŒ‡æ•¸' },\n      { symbol: 'IX0018', name: 'é›»å™¨é›»çºœé¡æŒ‡æ•¸' },\n      { symbol: 'IX0019', name: 'åŒ–å­¸ç”ŸæŠ€é†«ç™‚é¡æŒ‡æ•¸' },\n      { symbol: 'IX0020', name: 'åŒ–å­¸é¡æŒ‡æ•¸' },\n      { symbol: 'IX0021', name: 'ç”ŸæŠ€é†«ç™‚é¡æŒ‡æ•¸' },\n      { symbol: 'IX0022', name: 'ç»ç’ƒé™¶ç“·é¡æŒ‡æ•¸' },\n      { symbol: 'IX0023', name: 'é€ ç´™é¡æŒ‡æ•¸' },\n      { symbol: 'IX0024', name: 'é‹¼éµé¡æŒ‡æ•¸' },\n      { symbol: 'IX0025', name: 'æ©¡è† é¡æŒ‡æ•¸' },\n      { symbol: 'IX0026', name: 'æ±½è»Šé¡æŒ‡æ•¸' },\n      { symbol: 'IX0027', name: 'é›»å­å·¥æ¥­é¡æŒ‡æ•¸' },\n      { symbol: 'IX0028', name: 'åŠå°é«”é¡æŒ‡æ•¸' },\n      { symbol: 'IX0029', name: 'é›»è…¦åŠé€±é‚Šè¨­å‚™é¡æŒ‡æ•¸' },\n      { symbol: 'IX0030', name: 'å…‰é›»é¡æŒ‡æ•¸' },\n      { symbol: 'IX0031', name: 'é€šä¿¡ç¶²è·¯é¡æŒ‡æ•¸' },\n      { symbol: 'IX0032', name: 'é›»å­é›¶çµ„ä»¶é¡æŒ‡æ•¸' },\n      { symbol: 'IX0033', name: 'é›»å­é€šè·¯é¡æŒ‡æ•¸' },\n      { symbol: 'IX0034', name: 'è³‡è¨Šæœå‹™é¡æŒ‡æ•¸' },\n      { symbol: 'IX0035', name: 'å…¶ä»–é›»å­é¡æŒ‡æ•¸' },\n      { symbol: 'IX0036', name: 'å»ºæç‡Ÿé€ é¡æŒ‡æ•¸' },\n      { symbol: 'IX0037', name: 'èˆªé‹é¡æŒ‡æ•¸' },\n      { symbol: 'IX0038', name: 'è§€å…‰é¡æŒ‡æ•¸' },\n      { symbol: 'IX0039', name: 'é‡‘èä¿éšªé¡æŒ‡æ•¸' },\n      { symbol: 'IX0040', name: 'è²¿æ˜“ç™¾è²¨é¡æŒ‡æ•¸' },\n      { symbol: 'IX0041', name: 'æ²¹é›»ç‡ƒæ°£é¡æŒ‡æ•¸' },\n      { symbol: 'IX0185', name: 'ç¶ èƒ½ç’°ä¿é¡æŒ‡æ•¸' },\n      { symbol: 'IX0186', name: 'æ•¸ä½é›²ç«¯é¡æŒ‡æ•¸' },\n      { symbol: 'IX0187', name: 'é‹å‹•ä¼‘é–’é¡æŒ‡æ•¸' },\n      { symbol: 'IX0188', name: 'å±…å®¶ç”Ÿæ´»é¡æŒ‡æ•¸' },\n      { symbol: 'IX0042', name: 'å…¶ä»–é¡æŒ‡æ•¸' },\n    ];\n\n    const quotes = json.data.flatMap((row) => {\n      const [time, ...values] = row;\n      return values.map((value, i) => ({\n        date,\n        time,\n        symbol: indices[i].symbol,\n        name: indices[i].name,\n        price: numeral(value).value(),\n      }));\n    });\n\n    return _(quotes)\n      .groupBy('symbol')\n      .map((quotes) => {\n        const [prev, ...rows] = quotes;\n        const { date, symbol, name } = prev;\n        const data: Record<string, any> = { date, symbol, name };\n        data.openPrice = _.minBy(rows, 'time').price;\n        data.highPrice = _.maxBy(rows, 'price').price;\n        data.lowPrice = _.minBy(rows, 'price').price;\n        data.closePrice = _.maxBy(rows, 'time').price;\n        data.change = numeral(data.closePrice).subtract(prev.price).value();\n        data.changePercent = +numeral(data.change)\n          .divide(prev.price)\n          .multiply(100)\n          .format('0.00');\n        return data;\n      })\n      .value();\n  }\n\n  async fetchIndicesTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/afterTrading/BFIAMU?${query}`;\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    const market = await this.fetchMarketTrades({ date });\n    if (!market) {\n      return null;\n    }\n\n    const indices = [\n      { symbol: 'IX0010', name: 'æ°´æ³¥é¡æŒ‡æ•¸' },\n      { symbol: 'IX0011', name: 'é£Ÿå“é¡æŒ‡æ•¸' },\n      { symbol: 'IX0012', name: 'å¡‘è† é¡æŒ‡æ•¸' },\n      { symbol: 'IX0016', name: 'ç´¡ç¹”çº–ç¶­é¡æŒ‡æ•¸' },\n      { symbol: 'IX0017', name: 'é›»æ©Ÿæ©Ÿæ¢°é¡æŒ‡æ•¸' },\n      { symbol: 'IX0018', name: 'é›»å™¨é›»çºœé¡æŒ‡æ•¸' },\n      { symbol: 'IX0019', name: 'åŒ–å­¸ç”ŸæŠ€é†«ç™‚é¡æŒ‡æ•¸' },\n      { symbol: 'IX0020', name: 'åŒ–å­¸é¡æŒ‡æ•¸' },\n      { symbol: 'IX0021', name: 'ç»ç’ƒé™¶ç“·é¡æŒ‡æ•¸' },\n      { symbol: 'IX0022', name: 'ç»ç’ƒé™¶ç“·é¡æŒ‡æ•¸' },\n      { symbol: 'IX0023', name: 'é€ ç´™é¡æŒ‡æ•¸' },\n      { symbol: 'IX0024', name: 'é‹¼éµé¡æŒ‡æ•¸' },\n      { symbol: 'IX0025', name: 'æ©¡è† é¡æŒ‡æ•¸' },\n      { symbol: 'IX0026', name: 'æ±½è»Šé¡æŒ‡æ•¸' },\n      { symbol: 'IX0027', name: 'é›»å­å·¥æ¥­é¡æŒ‡æ•¸' },\n      { symbol: 'IX0028', name: 'åŠå°é«”é¡æŒ‡æ•¸' },\n      { symbol: 'IX0029', name: 'é›»è…¦åŠé€±é‚Šè¨­å‚™é¡æŒ‡æ•¸' },\n      { symbol: 'IX0030', name: 'å…‰é›»é¡æŒ‡æ•¸' },\n      { symbol: 'IX0031', name: 'é€šä¿¡ç¶²è·¯é¡æŒ‡æ•¸' },\n      { symbol: 'IX0032', name: 'é›»å­é›¶çµ„ä»¶é¡æŒ‡æ•¸' },\n      { symbol: 'IX0033', name: 'é›»å­é€šè·¯é¡æŒ‡æ•¸' },\n      { symbol: 'IX0034', name: 'è³‡è¨Šæœå‹™é¡æŒ‡æ•¸' },\n      { symbol: 'IX0035', name: 'å…¶ä»–é›»å­é¡æŒ‡æ•¸' },\n      { symbol: 'IX0036', name: 'å»ºæç‡Ÿé€ é¡æŒ‡æ•¸' },\n      { symbol: 'IX0037', name: 'èˆªé‹é¡æŒ‡æ•¸' },\n      { symbol: 'IX0038', name: 'è§€å…‰äº‹æ¥­é¡æŒ‡æ•¸' },\n      { symbol: 'IX0039', name: 'é‡‘èä¿éšªé¡æŒ‡æ•¸' },\n      { symbol: 'IX0040', name: 'è²¿æ˜“ç™¾è²¨é¡æŒ‡æ•¸' },\n      { symbol: 'IX0041', name: 'æ²¹é›»ç‡ƒæ°£é¡æŒ‡æ•¸' },\n      { symbol: 'IX0042', name: 'å…¶ä»–é¡æŒ‡æ•¸' },\n      { symbol: 'IX0185', name: 'ç¶ èƒ½ç’°ä¿é¡æŒ‡æ•¸' },\n      { symbol: 'IX0186', name: 'æ•¸ä½é›²ç«¯é¡æŒ‡æ•¸' },\n      { symbol: 'IX0187', name: 'é‹å‹•ä¼‘é–’é¡æŒ‡æ•¸' },\n      { symbol: 'IX0188', name: 'å±…å®¶ç”Ÿæ´»é¡æŒ‡æ•¸' },\n    ];\n\n    return json.data.map((row, i) => {\n      const { symbol, name } = indices[i];\n      const data: Record<string, any> = { date, symbol, name };\n      data.tradeVolume = numeral(row[1]).value();\n      data.tradeValue = numeral(row[2]).value();\n      data.tradeWeight = +numeral(data.tradeValue)\n        .divide(market.tradeValue)\n        .multiply(100)\n        .format('0.00');\n      return data;\n    });\n  }\n\n  async fetchEquitiesQuotes(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      type: 'ALLBUT0999',\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/afterTrading/MI_INDEX?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    return json.tables[8].data.map((row) => {\n      const [symbol, name, ...values] = row;\n      const data: Record<string, any> = { date, symbol, name };\n      data.openPrice = numeral(values[3]).value();\n      data.highPrice = numeral(values[4]).value();\n      data.lowPrice = numeral(values[5]).value();\n      data.closePrice = numeral(values[6]).value();\n      data.tradeVolume = numeral(values[0]).value();\n      data.tradeValue = numeral(values[2]).value();\n      data.transaction = numeral(values[1]).value();\n      data.change = values[7].includes('green')\n        ? numeral(values[8]).multiply(-1).value()\n        : numeral(values[8]).value();\n      data.changePercent = data.closePrice\n        ? +numeral(data.change)\n            .divide(data.closePrice - data.change)\n            .multiply(100)\n            .format('0.00')\n        : 0;\n      return data;\n    });\n  }\n\n  async fetchEquitiesInstInvestorsTrades(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      selectType: 'ALLBUT0999',\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/fund/T86?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    return json.data.map((row) => {\n      const [symbol, name, ...values] = row;\n      const data: Record<string, any> = { date, symbol, name };\n      data.finiNetBuySell =\n        numeral(values[4]).value() + numeral(values[7]).value(); // å¤–é™¸è³‡è²·è³£è¶… + å¤–è³‡è‡ªç‡Ÿå•†è²·è³£è¶…\n      data.sitcNetBuySell = numeral(values[10]).value(); // æŠ•ä¿¡è²·è³£è¶…\n      data.dealersNetBuySell = numeral(values[11]).value(); // è‡ªç‡Ÿå•†è²·è³£è¶…\n      return data;\n    });\n  }\n\n  async fetchEquitiesValues(options?: { date: string }) {\n    const date = options?.date ?? DateTime.local().toISODate();\n    const query = new URLSearchParams({\n      date: DateTime.fromISO(date).toFormat('yyyyMMdd'),\n      selectType: 'ALL',\n      response: 'json',\n    });\n    const url = `https://www.twse.com.tw/rwd/zh/afterTrading/BWIBBU_d?${query}`;\n\n    const response = await firstValueFrom(this.httpService.get(url));\n    const json = response.data.stat === 'OK' && response.data;\n    if (!json) {\n      return null;\n    }\n\n    return json.data.map((row) => {\n      const [symbol, name, ...values] = row;\n      const data: Record<string, any> = { date, symbol, name };\n      data.peRatio = numeral(values[2]).value();\n      data.pbRatio = numeral(values[3]).value();\n      data.dividendYield = numeral(values[0]).value();\n      data.dividendYear = numeral(values[1]).value();\n      return data;\n    });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/usdt-scraper.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/scraper/yahoo-finance.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/enums/exchange.enum.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/enums/index.enum.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/enums/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/enums/market.enum.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/enums/ticker-type.enum.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/ticker.module.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/ticker.repository.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":70,"column":11,"nodeType":"MemberExpression","endLine":70,"endColumn":25},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":70,"column":43,"nodeType":"MemberExpression","endLine":70,"endColumn":58},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":70,"column":63,"nodeType":"MemberExpression","endLine":70,"endColumn":77}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model } from 'mongoose';\nimport { Ticker, TickerDocument } from './ticker.schema';\n\n@Injectable()\nexport class TickerRepository {\n  constructor(\n    @InjectModel(Ticker.name) private readonly model: Model<TickerDocument>,\n  ) {}\n\n  async updateTicker(ticker: Partial<Ticker>) {\n    const { date, symbol } = ticker;\n    return this.model.updateOne({ date, symbol }, ticker, { upsert: true });\n  }\n\n  /**\n   * æª¢æŸ¥æŒ‡å®šæ—¥æœŸå’Œä»£è™Ÿçš„è³‡æ–™æ˜¯å¦å·²å­˜åœ¨\n   */\n  async hasTicker(date: string, symbol: string): Promise<boolean> {\n    const count = await this.model.countDocuments({ date, symbol });\n    return count > 0;\n  }\n\n  /**\n   * ç²å–æŒ‡å®šæ—¥æœŸå’Œä»£è™Ÿçš„ç¾æœ‰è³‡æ–™\n   */\n  async getTicker(\n    date: string,\n    symbol: string,\n  ): Promise<TickerDocument | null> {\n    return this.model.findOne({ date, symbol });\n  }\n\n  /**\n   * æ‰¹é‡æª¢æŸ¥ç‰¹å®šæ—¥æœŸçš„è³‡æ–™æ•¸é‡\n   */\n  async getTickerCount(\n    date: string,\n    filters?: Partial<Ticker>,\n  ): Promise<number> {\n    const query = { date, ...filters };\n    return this.model.countDocuments(query);\n  }\n\n  /**\n   * æª¢æŸ¥è³‡æ–™æ˜¯å¦éœ€è¦æ›´æ–°\n   */\n  async needsUpdate(\n    date: string,\n    symbol: string,\n    newData: Partial<Ticker>,\n  ): Promise<boolean> {\n    const existing = await this.getTicker(date, symbol);\n    if (!existing) {\n      return true;\n    }\n\n    // æ¯”è¼ƒé—œéµæ¬„ä½\n    const keyFields = [\n      'closePrice',\n      'openPrice',\n      'highPrice',\n      'lowPrice',\n      'volume',\n      'tradeValue',\n    ];\n\n    for (const field of keyFields) {\n      if (newData[field] !== undefined && existing[field] !== newData[field]) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * æ™ºèƒ½æ‰¹é‡æ›´æ–°\n   */\n  async smartBatchUpdate(\n    tickers: Partial<Ticker>[],\n  ): Promise<{ updated: number; skipped: number; total: number }> {\n    let updated = 0;\n    let skipped = 0;\n\n    for (const ticker of tickers) {\n      const { date, symbol } = ticker;\n      if (!date || !symbol) {\n        continue;\n      }\n\n      const needsUpdate = await this.needsUpdate(date, symbol, ticker);\n      if (needsUpdate) {\n        await this.updateTicker(ticker);\n        updated++;\n      } else {\n        skipped++;\n      }\n    }\n\n    return { updated, skipped, total: tickers.length };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/ticker.schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/ming/Desktop/ch026/src/ticker/ticker.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
